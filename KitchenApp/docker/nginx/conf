events {}

http {
    upstream auths {
        server authservice;
    }

    upstream inv {
        server inventory;
    }

    upstream wsh {
        server wishlist;
    }

    upstream users {
        server userservice;
    }

    server {
        server_name kitchen.app;

        location /login {
           proxy_pass http://auths/login;
        }

        location /signup {
           proxy_pass http://auths/signup;
        }

        location /auth {
            internal;
            proxy_method GET;
            proxy_pass_request_body off;
            proxy_set_header Content-Length 0;
            proxy_pass http://auths/auth;
        }

        location /user/ {
            if ($request_method = OPTIONS) {
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
                add_header Access-Control-Allow-Origin $http_origin;
                add_header Access-Control-Allow-Headers "auth, Content-Type";
                add_header Access-Control-Allow-Credentials true;
                return 200;
            }
            auth_request /auth;
            auth_request_set $auth_header_auth $upstream_http_header_auth;
            proxy_pass http://users/;
        }

        location /inventory/ {
            if ($request_method = OPTIONS) {
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
                add_header Access-Control-Allow-Origin $http_origin;
                add_header Access-Control-Allow-Headers "auth, Content-Type";
                add_header Access-Control-Allow-Credentials true;
                return 200;
            }
            auth_request /auth;
            auth_request_set $auth_header_auth $upstream_http_header_auth;
            proxy_pass http://inv/;
        }

        location /wishlist/ {
            if ($request_method = OPTIONS) {
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
                add_header Access-Control-Allow-Origin $http_origin;
                add_header Access-Control-Allow-Headers "auth, Content-Type";
                add_header Access-Control-Allow-Credentials true;
                return 200;
            }
            auth_request /auth;
            auth_request_set $auth_header_auth $upstream_http_header_auth;
            proxy_pass http://wsh/;
        }
    }
}

